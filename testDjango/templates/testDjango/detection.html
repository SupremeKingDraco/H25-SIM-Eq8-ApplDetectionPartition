<!DOCTYPE html>
{% load static %}

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detection</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/traducteurPage.css' %}">
     <script src="{% static 'js/main.js' %}" defer></script>
</head>
<body>

<div class="video-bg">
    <video autoplay muted loop>
        <source src="{% static 'image/web page final background.mp4' %}" type="video/mp4">
    </video>
</div>

<button class="floating-btn">Information</button>

<div class="main-card">
    <h3>YouTube to Piano Sheet Music</h3>

    <div class="input-group">
        <label for="userInput">Audio File Path</label>
        <input type="text" id="userInput" placeholder="Paste absolute path...">
    </div>

    <div class="btn-group">
        <button class="btn-primary" onclick="handleButtonClick(4, 'image')">Image</button>
        <button class="btn-primary" onclick="handleButtonClick(2, 'audio')">Audio</button>
        <button class="btn-secondary" onclick="handleButtonClick(1, 'transpose')">Transpose</button>
    </div>

    <div id="dynamic-inputs" class="input-container"></div>

<!--    Juste pour debug pour voir si l'information est recu-->
<!--    <div id="display-area">-->
<!--        <pre id="input-data">Attende du Input...</pre>-->
<!--    </div>-->

    <button id="submitButton">Process</button>
</div>

<script>
  let treatmentSelected = false;
  let selectedTreatment = ""; // Variable pour traquer le traitement

  /**
   * Fonction pour créer des champs de texte dynamiques
   * @param {number} count - Nombre de champs d'entrée à créer
   * @param {string} treatmentType - Type de traitement sélectionné (image ou audio)
   */
  function createInputs(count, treatmentType) {
    // Efface les champs d'entrée précédemment créés
    const inputContainer = document.getElementById('dynamic-inputs');
    inputContainer.innerHTML = '';

    // Définit tagName en fonction du compte
    let tagName = [];
    if (treatmentType === "audio") {
        tagName = ["Seuil de décibel. (recommander entre -40 et -10)","Path pour extraire et download mp3 du mp4"];
    } else if (treatmentType === "image") {
        tagName = ["bpm", "nombre bemole/ diez", "premiere note ex: Do=0 La=5","premiere octave ex: 4"];
    } else {
    tagName = ["Nouvelle gamme ex: F#"];
    }

    // Crée le nombre spécifié de champs d'entrée
    for (let i = 0; i < count; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = tagName[i];



        inputContainer.appendChild(input);
    }

    // Définit treatmentSelected sur true lorsque les champs d'entrée sont créés
    treatmentSelected = true;
  }

  /**
   * Fonction pour gérer les événements de clic sur les boutons
   * @param {number} count - Nombre de champs d'entrée à créer
   * @param {string} treatmentType - Type de traitement sélectionné (image ou audio)
   */
  function handleButtonClick(count, treatmentType) {
    selectedTreatment = treatmentType; // Stocke le type de traitement sélectionné
    createInputs(count, treatmentType);
  }

  /**
   * Fonction pour récupérer les données d'entrée de la page
   */
  function retrieveInputData() {
    // Vérifie si une option de traitement a été sélectionnée
    if (!treatmentSelected) {
      alert("Veuillez d'abord sélectionner une option de traitement.");
      return;
    }

    // Récupère la valeur du champ d'entrée statique
    const userInput = document.getElementById('userInput').value;
    if (userInput.trim() === "") {
      alert("Veuillez entrer du texte dans le champ d'entrée.");
      return;
    }

    // Récupère les valeurs des champs d'entrée dynamiques
    const dynamicInputs = document.querySelectorAll('#dynamic-inputs input');
    const dynamicInputValues = [];
    let allInputsFilled = true;

    dynamicInputs.forEach((input, index) => {
      if (input.value.trim() === "") {
        allInputsFilled = false;
      }
      dynamicInputValues.push(input.value);
    });

    if (!allInputsFilled) {
      alert("Veuillez remplir tous les champs d'entrée dynamiques.");
      return;
    }

    // Affiche les données dans la zone d'affichage
    //displayInputData(userInput, dynamicInputValues, selectedTreatment);

    // Traite les données si nécessaire
    processData(userInput, dynamicInputs, selectedTreatment); // Passe le traitement selectionné
  }

  /**
   * Fonction pour afficher les données d'entrée sur la page web pour débogage
   * @param {string} userInput - Valeur du champ d'entrée statique
   * @param {array} dynamicInputValues - Valeurs des champs d'entrée dynamiques
   * @param {string} selectedTreatment - Type de traitement sélectionné (image ou audio)
   */
  function displayInputData(userInput, dynamicInputValues, selectedTreatment) {
    const displayArea = document.getElementById('input-data');
    displayArea.innerHTML = `Entrée Utilisateur : ${userInput}\n`;
    displayArea.innerHTML += `Traitement Sélectionné : ${selectedTreatment === "image" ? "Traitement image" : "Traitement audio"}\n`;
    dynamicInputValues.forEach((value, index) => {
      displayArea.innerHTML += `Entrée Dynamique ${index + 1} : ${value}\n`;
    });
  }

  /**
   * Fonction pour traiter les données récupérées
   * @param {string} userInput - Valeur du champ d'entrée statique
   * @param {NodeList} dynamicInputs - Valeurs des champs d'entrée dynamiques
   * @param {string} selectedTreatment - Type de traitement sélectionné (image ou audio)
   */
  function processData(userInput, dynamicInputs, selectedTreatment) {
    const parsedDynamicInputs = [];

    console.log("Traitement sélectionné:", selectedTreatment);
    console.log("Données utilisateur:", userInput);
    console.log("Données dynamiques:", Array.from(dynamicInputs).map(input => input.value));

    dynamicInputs.forEach((element) => {
        parsedDynamicInputs.push(element.value);
    });

    console.log(parsedDynamicInputs);


    // logique spécifique au traitement sélectionné
    if (selectedTreatment === "image") {
      console.log("Traitement de l'image...");
    } else if (selectedTreatment === "audio") {
      console.log("Traitement de l'audio...");
    }

    const params = {
        method:"POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            userInput: userInput,
            parsedDynamicInputs: parsedDynamicInputs,
            selectedTreatment: selectedTreatment,
        }),
    }

    console.log(params);
    fetch("/detection-api/", params).then((response) => {
        console.log(response);
    });
  }

  // Ajoute un écouteur d'événements au bouton de soumissions
  document.getElementById('submitButton').addEventListener('click', () => {
    retrieveInputData();
  });
</script>

</body>
</html>
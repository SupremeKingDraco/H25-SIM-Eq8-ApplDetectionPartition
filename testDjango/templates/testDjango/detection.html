<!DOCTYPE html>


<!--Encore une page de test-->


{% load static %}

<html lang="fr">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Detection</title>
    <link rel="stylesheet" href="{% static 'css/traducteurPage.css' %}">
    <script src="{% static 'js/main.js' %}" defer></script>
    <!-- Bouton Fixe -->
    <button class="fixed-button">Partition</button>
    <style>
        #display-area {
            background-color: white;
            padding: 20px;
            margin-top: 20px;
            color: black; /* Assure que le texte est en noir */
        }
        #input-data {
            white-space: pre-wrap; /* Préserve les espaces et les retours à la ligne */
            word-wrap: break-word; /* Coupe les mots longs */
        }
    </style>
</head>
<body>

<!-- Arrière-plan Vidéo -->
<div class="video-background">
  <video autoplay muted loop>
    <source src="{% static 'image/web page final background.mp4' %}" type="video/mp4">
    Votre navigateur ne supporte pas la balise vidéo.
  </video>
</div>

<div style="background-color: rgba(0, 0, 0, 0.8); width: 1300px;height: 700px;">
    <h3> Convertisseur video youtube à partition de piano</h3>

    <label for="userInput">Entrez le absolute path de la chanson :</label>
    <input type="text" id="userInput" name="userInput" placeholder="Tapez ici...">
    <hr>
    <p class="btn-group">
        <button style="width:33%" id="button1" onclick="handleButtonClick(4, 'image')">Traitement image</button>
        <button style="width:33%" id="button2" onclick="handleButtonClick(2, 'audio')">Traitement audio</button>
        <button style="width:33%" id="button3" onclick="handleButtonClick(1, 'transpose')">Transpose</button>
    </p>
    <!-- Conteneur pour les champs d'entrée dynamiques -->
    <div id="dynamic-inputs" class="input-container"></div>
</div>

<!-- Zone d'affichage pour les données d'entrée -->
<div id="display-area">
    <h4>Données d'entrée :</h4>
    <pre id="input-data"></pre>
</div>

<!-- Bouton de Soumission -->
<button id="submitButton">Soumettre</button>

<script>
  let treatmentSelected = false;
  let selectedTreatment = ""; // Variable pour traquer le traitement

  /**
   * Fonction pour créer des champs de texte dynamiques
   * @param {number} count - Nombre de champs d'entrée à créer
   * @param {string} treatmentType - Type de traitement sélectionné (image ou audio)
   */
  function createInputs(count, treatmentType) {
    // Efface les champs d'entrée précédemment créés
    const inputContainer = document.getElementById('dynamic-inputs');
    inputContainer.innerHTML = '';

    // Définit tagName en fonction du compte
    let tagName = [];
    if (treatmentType === "audio") {
        tagName = ["Seuil de décibel. (recommander entre -40 et -10)","Path pour extraire et download mp3 du mp4"];
    } else if (treatmentType === "image") {
        tagName = ["bpm", "nombre bemole/ diez", "premiere note ex: Do=0 La=5","premiere octave ex: 4"];
    } else {
    tagName = ["Nouvelle gamme ex: F#"];
    }

    // Crée le nombre spécifié de champs d'entrée
    for (let i = 0; i < count; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = tagName[i];



        inputContainer.appendChild(input);
    }

    // Définit treatmentSelected sur true lorsque les champs d'entrée sont créés
    treatmentSelected = true;
  }

  /**
   * Fonction pour gérer les événements de clic sur les boutons
   * @param {number} count - Nombre de champs d'entrée à créer
   * @param {string} treatmentType - Type de traitement sélectionné (image ou audio)
   */
  function handleButtonClick(count, treatmentType) {
    selectedTreatment = treatmentType; // Stocke le type de traitement sélectionné
    createInputs(count, treatmentType);
  }

  /**
   * Fonction pour récupérer les données d'entrée de la page
   */
  function retrieveInputData() {
    // Vérifie si une option de traitement a été sélectionnée
    if (!treatmentSelected) {
      alert("Veuillez d'abord sélectionner une option de traitement.");
      return;
    }

    // Récupère la valeur du champ d'entrée statique
    const userInput = document.getElementById('userInput').value;
    if (userInput.trim() === "") {
      alert("Veuillez entrer du texte dans le champ d'entrée.");
      return;
    }

    // Récupère les valeurs des champs d'entrée dynamiques
    const dynamicInputs = document.querySelectorAll('#dynamic-inputs input');
    const dynamicInputValues = [];
    let allInputsFilled = true;

    dynamicInputs.forEach((input, index) => {
      if (input.value.trim() === "") {
        allInputsFilled = false;
      }
      dynamicInputValues.push(input.value);
    });

    if (!allInputsFilled) {
      alert("Veuillez remplir tous les champs d'entrée dynamiques.");
      return;
    }

    // Affiche les données dans la zone d'affichage
    displayInputData(userInput, dynamicInputValues, selectedTreatment);

    // Traite les données si nécessaire
    processData(userInput, dynamicInputs, selectedTreatment); // Passe le traitement selectionné
  }

  /**
   * Fonction pour afficher les données d'entrée sur la page web pour débogage
   * @param {string} userInput - Valeur du champ d'entrée statique
   * @param {array} dynamicInputValues - Valeurs des champs d'entrée dynamiques
   * @param {string} selectedTreatment - Type de traitement sélectionné (image ou audio)
   */
  function displayInputData(userInput, dynamicInputValues, selectedTreatment) {
    const displayArea = document.getElementById('input-data');
    displayArea.innerHTML = `Entrée Utilisateur : ${userInput}\n`;
    displayArea.innerHTML += `Traitement Sélectionné : ${selectedTreatment === "image" ? "Traitement image" : "Traitement audio"}\n`;
    dynamicInputValues.forEach((value, index) => {
      displayArea.innerHTML += `Entrée Dynamique ${index + 1} : ${value}\n`;
    });
  }

  /**
   * Fonction pour traiter les données récupérées
   * @param {string} userInput - Valeur du champ d'entrée statique
   * @param {NodeList} dynamicInputs - Valeurs des champs d'entrée dynamiques
   * @param {string} selectedTreatment - Type de traitement sélectionné (image ou audio)
   */
  function processData(userInput, dynamicInputs, selectedTreatment) {
    const parsedDynamicInputs = [];

    console.log("Traitement sélectionné:", selectedTreatment);
    console.log("Données utilisateur:", userInput);
    console.log("Données dynamiques:", Array.from(dynamicInputs).map(input => input.value));

    dynamicInputs.forEach((element) => {
        parsedDynamicInputs.push(element.value);
    });

    console.log(parsedDynamicInputs);


    // logique spécifique au traitement sélectionné
    if (selectedTreatment === "image") {
      console.log("Traitement de l'image...");
    } else if (selectedTreatment === "audio") {
      console.log("Traitement de l'audio...");
    }

    const params = {
        method:"POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            userInput: userInput,
            parsedDynamicInputs: parsedDynamicInputs,
            selectedTreatment: selectedTreatment,
        }),
    }

    console.log(params);
    fetch("/detection-api/", params).then((response) => {
        console.log(response);
    });
  }

  // Ajoute un écouteur d'événements au bouton de soumissions
  document.getElementById('submitButton').addEventListener('click', () => {
    retrieveInputData();
  });
</script>

</body>
</html>